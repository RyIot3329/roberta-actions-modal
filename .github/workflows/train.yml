# .github/workflows/train.yml
#
# Fine-tune RoBERTa on Modal and commit results back to repo
# Creates a pull request with training results

name: Fine-tune RoBERTa

on:
  workflow_dispatch:
    inputs:
      epochs:
        description: "Number of training epochs"
        required: false
        default: "2"
      batch_size:
        description: "Batch size"
        required: false
        default: "8"

  push:
    branches: [main]
    paths:
      - "data/**"
      - "scripts/**"

env:
  PYTHON_VERSION: "3.10"

jobs:
  train:
    name: Fine-tune on Modal
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Modal
        run: pip install modal

      - name: Configure Modal
        run: |
          modal token set \
            --token-id ${{ secrets.MODAL_TOKEN_ID }} \
            --token-secret ${{ secrets.MODAL_TOKEN_SECRET }}

      - name: Create output directory
        run: mkdir -p output

      - name: Run fine-tuning on Modal
        id: train
        run: |
          echo "Starting Modal training..."
          modal run ./scripts/finetune.py \
            --epochs ${{ github.event.inputs.epochs || '2' }} \
            --batch-size ${{ github.event.inputs.batch_size || '8' }}

          # Get the output filename
          OUTPUT_FILE=$(ls -t output/*.txt | head -1)
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "output_filename=$(basename $OUTPUT_FILE)" >> $GITHUB_OUTPUT

          # Add to workflow summary
          echo "## Training Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add training results: ${{ steps.train.outputs.output_filename }}"
          branch: training-results-${{ github.run_id }}
          delete-branch: true
          title: "ðŸ¤– Training Results - ${{ steps.train.outputs.output_filename }}"
          body: |
            ## Automated Training Results

            Training completed successfully on Modal.

            **Config:** ${{ github.event.inputs.epochs || '2' }} epochs, batch size ${{ github.event.inputs.batch_size || '8' }}

            **Results file:** `${{ steps.train.outputs.output_file }}`

            ðŸ“Š [View full results in workflow summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: |
            automated
            training-results

      - name: Summary
        run: |
          echo "=========================================="
          echo "TRAINING COMPLETE"
          echo "=========================================="
          echo "Output: ${{ steps.train.outputs.output_file }}"
          echo "PR created for branch: training-results-${{ github.run_id }}"
          echo "=========================================="
