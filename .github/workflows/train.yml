# .github/workflows/train.yml
#
# Fine-tune RoBERTa on Modal and commit results back to repo
# Creates a pull request with training results

name: Fine-tune RoBERTa

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '2'
      batch_size:
        description: 'Batch size'
        required: false
        default: '8'

  # Trigger on push to data directory
  push:
    branches: [main]
    paths:
      - 'data/**'

env:
  PYTHON_VERSION: '3.10'

jobs:
  train:
    name: Fine-tune on Modal
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. Install Modal
      - name: Install Modal
        run: pip install modal

      # 4. Configure Modal authentication
      - name: Configure Modal
        run: |
          modal token set \
            --token-id ${{ secrets.MODAL_TOKEN_ID }} \
            --token-secret ${{ secrets.MODAL_TOKEN_SECRET }}

      # 5. Ensure output directory exists
      - name: Create output directory
        run: mkdir -p output

      # 6. Run training on Modal
      - name: Run fine-tuning on Modal
        id: train
        run: |
          echo "Starting Modal training..."
          modal run finetune.py \
            --epochs ${{ github.event.inputs.epochs || '2' }} \
            --batch-size ${{ github.event.inputs.batch_size || '8' }}
          
          # Capture the output filename
          OUTPUT_FILE=$(ls -t output/*.txt | head -1)
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "Training complete. Output: $OUTPUT_FILE"

      # 7. Create branch and commit results
      - name: Commit results to new branch
        id: commit
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create timestamp for branch name
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BRANCH_NAME="training-results-${TIMESTAMP}"
          
          # Create new branch
          git checkout -b $BRANCH_NAME
          
          # Add output file
          git add output/
          
          # Commit
          git commit -m "Add training results from Modal run

          - Epochs: ${{ github.event.inputs.epochs || '2' }}
          - Batch size: ${{ github.event.inputs.batch_size || '8' }}
          - Triggered by: ${{ github.event_name }}
          - Run ID: ${{ github.run_id }}"
          
          # Push branch
          git push origin $BRANCH_NAME
          
          # Output branch name for PR step
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # 8. Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.commit.outputs.branch_name }}
          base: main
          title: "ðŸ¤– Training Results - ${{ steps.commit.outputs.branch_name }}"
          body: |
            ## Automated Training Results
            
            This PR was automatically created by the CI/CD pipeline after a successful training run on Modal.
            
            ### Training Configuration
            - **Model**: FacebookAI/roberta-base
            - **Epochs**: ${{ github.event.inputs.epochs || '2' }}
            - **Batch Size**: ${{ github.event.inputs.batch_size || '8' }}
            
            ### Trigger
            - **Event**: ${{ github.event_name }}
            - **Run ID**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit**: ${{ github.sha }}
            
            ### Output File
            Check the `output/` directory for the training results file.
            
            ---
            
            **Please review the results and merge if satisfactory.**
          labels: |
            automated
            training-results
          draft: false

      # 9. Print summary
      - name: Print summary
        run: |
          echo "=========================================="
          echo "TRAINING COMPLETE"
          echo "=========================================="
          echo "Output file: ${{ steps.train.outputs.output_file }}"
          echo "Branch: ${{ steps.commit.outputs.branch_name }}"
          echo "Pull request created!"
          echo "=========================================="
          echo ""
          echo "Results:"
          cat ${{ steps.train.outputs.output_file }}
